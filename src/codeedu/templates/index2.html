<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>CrewAI å¯¹è¯ç³»ç»Ÿ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #conversations-list li { cursor: pointer; margin: 5px 0; }
    #conversations-list li.active { font-weight: bold; color: green; }
    textarea { width: 100%; }
    button { padding: 8px 12px; margin-top: 10px; }
    #result-area { border: 1px solid #ccc; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>å¯¹è¯åˆ—è¡¨</h2>
  <ul id="conversations-list"></ul>
  <button id="new-convo-button"> æ–°å»ºå¯¹è¯</button>

  <h2>AI å¯¹è¯</h2>
  <form id="chat-form" onsubmit="return false;">
    <textarea id="input-message" placeholder="è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯..." rows="4"></textarea>
    <button type="button" id="send-button">å‘é€</button>
  </form>

  <h3>AI å›å¤</h3>
  <pre id="result-area"></pre>

  <script>

    document.getElementById("new-convo-button").addEventListener("click", async () => {
    const res = await fetch("/new_conversation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: "default" })  // å¯åŠ¨æ€ä¼ ç”¨æˆ· ID
    });

    const data = await res.json();
    const newCid = data.conversation_id;

    // é‡æ–°åŠ è½½æ‰€æœ‰å¯¹è¯åˆ—è¡¨å¹¶è‡ªåŠ¨é€‰ä¸­æ–°çš„
    await loadConversations();
    selectConversationById(newCid);
    });

    let currentConversationId = null;

    async function loadConversations() {
      const res = await fetch('/conversations');
      const conversations = await res.json();

      const listElement = document.getElementById('conversations-list');
      listElement.innerHTML = "";

      conversations.forEach(({ id, title }) => {
      const li = document.createElement('li');
      li.textContent = `ğŸ—¨ï¸ ${title}`;
      li.dataset.cid = id;
      li.onclick = () => selectConversation(id, li);
      listElement.appendChild(li);
      });
    }

    // è‡ªåŠ¨é€‰ä¸­æŸä¸ªå¯¹è¯å¹¶åŠ è½½å†…å®¹
    function selectConversationById(cid) {
      const targetLi = [...document.querySelectorAll("#conversations-list li")]
        .find(li => li.dataset.cid === cid);

      if (targetLi) {
        selectConversation(cid, targetLi);
      }
    }

    function selectConversation(cid, element) {
      currentConversationId = cid;//
      document.querySelectorAll("#conversations-list li").forEach(li => {
        li.classList.remove("active");
      });
      element.classList.add("active");
      //document.getElementById("result-area").textContent = "";
      loadConversationHistory(cid);
    }

    // åŠ è½½å¹¶å±•ç¤ºå¯¹è¯å†å²
    async function loadConversationHistory(cid) {
      const res = await fetch(`/conversation/${cid}`);
      const history = await res.json();

      const resultBox = document.getElementById("result-area");
      resultBox.innerText = ""; // æ¸…ç©ºæ—§å†…å®¹

      for (let message of history) {
        if (message.role === "user") {
          resultBox.innerText += `ä½ ï¼š${message.content}\n\n`;
        } else if (message.role === "assistant") {
          resultBox.innerText += `thought:${message.thought}\nassistant:${message.content}\n\n`;
        }
        
      }
    }

    document.getElementById("send-button").addEventListener("click", async () => {
      const message = document.getElementById("input-message").value.trim();
      const resultBox = document.getElementById("result-area");

      if (!message) {
        alert("è¯·è¾“å…¥æ¶ˆæ¯ï¼");
        return;
      }

      if (!currentConversationId) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è¯ï¼");
        return;
      }

      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          conversation_id: currentConversationId,
          message: message
        })
      });

      const data = await response.json();
      resultBox.innerText += `ä½ ï¼š${message}\nthought:${data.thought}\nassistant:${data.reply}\n\n`;
      document.getElementById("input-message").value = "";
    });

    loadConversations();
  </script>
</body>
</html>
